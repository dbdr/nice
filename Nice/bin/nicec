#! /bin/sh

### The Nice compiler
###
### Copyright 2000 Daniel Bonniot

JAVA=${JAVA-java}

usage_nicer()
{
  echo "usage: nicer path/to/file.jar"
  exit 1
}

## Parsing command line arguments

read_java_arg()
{
    if [ "x$1" = "x-g" ]; then
      JAVA="java_g -Djava.compiler=NONE"
    else
      JAVA="${JAVA} $1"
    fi
}

## Testing if nice is properly installed

test_installation()
{
    if [ ! -r ${NICE} ]; then
	echo "Nice was not found in ${NICE}"
	echo "Please move the Nice.jar there"
	echo "or set the NICE environment variable to the location of the Nice.jar file"
	exit 1
    fi
}


## Locating nice home

find_home()
{
  PRG="$0"
  # Resolve symlinks.
  while [ -h "$PRG" ]; do
    lsResult=`ls -ld "$PRG"`
    # d'apres /usr/bin/expr sous linux, ^ est implicite 
    # au debut de la deuxieme chaine et il ne faut pas le mettre
    link=`/usr/bin/expr "$lsResult" : '.*-> \(.*\)$'`
    if /usr/bin/expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG="`dirname $PRG`/$link"
    fi
  done

  APPHOME=`/usr/bin/expr "$PRG" : '\(.*\)/bin'`
  if [ -z ${APPHOME} ]; 
    then APPHOME=`dirname "$PRG"`/..
  fi
}

## Main part

scriptName="$0"
progname=`basename $0`
experimental=false

while true; do 
  case "x$1" in
    x-J*) read_java_arg "`expr substr "$1" 3 1000`";;
    x-e) 
	experimental=true
	NICE_TOP="$HOME"/Nice
    ;;
    *) break;;
    esac
  shift
  done

find_home "$scriptName"
NICEC=${APPHOME}/lib/nice/Nice.jar
STDLIB=${APPHOME}/lib/nice/stdlib.jar

if [ "$EMACS" = t ]; then
  JAVA="${JAVA} -Demacs=true"
fi

case $progname in
  nicec) 
    if [ $experimental = true ]; then
	NICEC=${NICE_TOP}/src/nice/tools/compiler.jar:${NICE_TOP}/stdlib:${NICE_TOP}/src:${NICE_TOP}/classes
	STDLIB=${NICE_TOP}/stdlib
    fi
    CLASSPATH=${NICEC}:${CLASSPATH}
    export CLASSPATH
    exec ${JAVA} \
	-Dnice.systemJar=${STDLIB} \
	nice.tools.compiler.package "$@"
  ;;
  nicer) 
    if [ $experimental = true ]; then
	NICEC=${NICE_TOP}/stdlib:${NICE_TOP}/classes
    fi
    jar=$1
    if [ -z "$jar" ]; then
      usage_nicer
    elif [ ! -f "$jar" ]; then
      if [ -f "${jar}.jar" ]; then
        jar="${jar}.jar"
      else
        echo "$jar does not exist"
        usage_nicer
      fi
    fi
    shift

    CLASSPATH=$jar:${NICEC}:$CLASSPATH
    export CLASSPATH
    exec ${JAVA} nice.tools.runJar ${jar} "$@"
  ;;
  *)
    echo "unknow nice command: ${progname}"
    exit 1
  ;;
esac
