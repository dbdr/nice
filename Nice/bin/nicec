#! /bin/sh

### The Nice compiler
###
### Copyright 2000 Daniel Bonniot

JAVA=${JAVA-java}

usage_nicer()
{
  echo "usage: nicer path/to/file.jar"
  exit 1
}

## Parsing command line arguments

read_java_arg()
{
    if [ "x$1" = "x-g" ]; then
      JAVA="java_g -Djava.compiler=NONE"
    else
      JAVA="${JAVA} $1"
    fi
}

## Testing if nice is properly installed

test_installation()
{
    if [ ! -r ${NICE} ]; then
	echo "Nice was not found in ${NICE}"
	echo "Please move the nice.jar file there"
	echo "or set the NICE environment variable to the location of the nice.jar file"
	exit 1
    fi
}


## Locating nice home

find_home()
{
  PRG="$0"
  # Resolve symlinks.
  while [ -h "$PRG" ]; do
    lsResult=`ls -ld "$PRG"`
    # d'apres expr sous linux, ^ est implicite 
    # au debut de la deuxieme chaine et il ne faut pas le mettre
    link=`expr "$lsResult" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG="`dirname $PRG`/$link"
    fi
  done

  APPHOME=`expr "$PRG" : '\(.*\)/bin'`
  if [ -z "${APPHOME}" ]; 
    then APPHOME=`dirname "$PRG"`/..
  fi
}

## Main part

scriptName="$0"
progname=`basename $0`
experimental=false

while true; do 
  case "x$1" in
    x-J*) read_java_arg "`expr substr "$1" 3 1000`";;
    x-e)  experimental=true ;;
    *) break;;
    esac
  shift
  done

find_home "$scriptName"
NICEC=${APPHOME}/share/java/nice.jar

case $progname in
  nicec) 
    # Having a trailing ":" at the end of CLASSPATH seems to act as ":." on some platforms.
    # We don't want that by default (if CLASSPATH is empty).
    if [ -z "${CLASSPATH}" ]; then
	CLASSPATH=${NICEC}
    else
	CLASSPATH=${NICEC}:${CLASSPATH}
    fi
    if [ $experimental = true ]; then
	CLASSPATH=${APPHOME}/classes:${APPHOME}/classes.old:${CLASSPATH}
    fi
    export CLASSPATH

    system_args="--runtime=${NICEC}"

    gcj="`which gcj 2>/dev/null`"
    # Check the string found is really a file
    # This is a work-around for a bug in OS X: 
    #   which gcj returns 0 (success) and prints "no gcj in $PATH"
    if [ -f "$gcj" ]; then
        system_args="${system_args} --native-compiler=${gcj}"
    fi

    exec ${JAVA} nice.tools.compiler.fun ${system_args} "$@"
  ;;
  nicer) 
    jar=$1
    if [ -z "$jar" ]; then
      usage_nicer
    elif [ ! -f "$jar" ]; then
      if [ -f "${jar}.jar" ]; then
        jar="${jar}.jar"
      else
        echo "$jar does not exist"
        usage_nicer
      fi
    fi
    shift

    CLASSPATH=$jar:${NICEC}:$CLASSPATH
    export CLASSPATH
    exec ${JAVA} nice.tools.runJar ${jar} "$@"
  ;;
  *)
    echo "unknow nice command: ${progname}"
    exit 1
  ;;
esac
